image: docker:latest

variables:
  GIT_STRATEGY: clone
  
services:
    - docker:dind

stages:
    - build
    - deploy

before_script:
    - sudo mkdir -p /etc/docker/certs.d/nexus.budg.bars.group/
    - sudo curl -o /etc/docker/certs.d/nexus.budg.bars.group/nexus.budg.bars.group.crt nexus.budg.bars.group/nexus.budg.bars.group.crt
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD nexus.budg.bars.group

build:
    stage: build
    only:
        - master
    script:
        - docker build -t nexus.budg.bars.group/databaser:latest .
    tags:
        - gitlab-databaser

deploy:
    stage: deploy
    only:
        - master

    script:
        - docker push nexus.budg.bars.group/databaser:latest
    tags:
        - gitlab-databaser